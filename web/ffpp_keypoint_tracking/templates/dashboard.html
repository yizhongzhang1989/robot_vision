<!DOCTYPE html>
<html lang="en">
<head>
    <meta c                        <h2>üéØ Visual API Call Monitoring</h2>!-- Visual API Call Monitoring Interface -->
        <div class="visual-monitoring-container">
            <!-- Monitoring Header -->
            <div class="monitoring-header">
                <h2>üéØ Visual Computation Monitoring</h2>t="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowFormer++ Keypoint Tracking Service</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üéØ FlowFormer++ Keypoint Tracking</h1>
            <p>High-performance keypoint tracking using FlowFormer++ deep learning model</p>
            <div class="status-banner {{ 'status-ready' if tracker_initialized else 'status-error' }}">
                <strong>Status:</strong> {{ '‚úÖ Ready' if tracker_initialized else '‚ùå Not Initialized' }}
                {% if gpu_available %}
                <span class="gpu-badge">üöÄ GPU Accelerated</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Service Status -->
        <div class="status-grid">
            <div class="status-card">
                <h3>üîß Service Status</h3>
                <div class="status-info">
                    <span class="label">Tracker:</span>
                    <span class="value {{ 'status-ok' if tracker_initialized else 'status-error' }}">
                        {{ 'Initialized' if tracker_initialized else 'Failed' }}
                    </span>
                </div>
                <div class="status-info">
                    <span class="label">Device:</span>
                    <span class="value">{{ device or 'Unknown' }}</span>
                </div>
                <div class="status-info">
                    <span class="label">Port:</span>
                    <span class="value">8001</span>
                </div>
            </div>
            
            <div class="status-card">
                <h3>üìä Reference Images</h3>
                <div class="reference-stats" id="reference-stats">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- API Call Monitoring Interface -->
        <div class="interface-grid">
            <!-- Recent API Calls Section -->
            <div class="interface-card" style="grid-column: 1 / -1;">
                <h2>ÔøΩ Recent API Calls</h2>
                <p>Monitor the last 5 API calls made to this FlowFormer++ service</p>
                
                <div id="api-call-feed" class="api-call-feed">
                    {% if recent_api_calls %}
                        {% for call in recent_api_calls %}
                            <div class="call-header">
                                <div class="call-info">
                                    <span class="call-endpoint">{{ call.endpoint }}</span>
                                    <span class="call-timestamp">{{ call.timestamp }}</span>
                                </div>
                                <div class="call-status">
                                    <span class="status-badge {{ 'success' if call.success else 'error' }}">
                                        {{ '‚úÖ Success' if call.success else '‚ùå Failed' }}
                                    </span>
                                    <span class="timing-badge">{{ call.processing_time }}s</span>
                                </div>
                            </div>

                            <div class="call-visual-content">
                                <div class="images-section">
                                    {% if call.ref_image_url %}
                                    <div class="image-display">
                                        <h4>üì∑ Reference Image ({{ call.ref_image_size or 'Unknown' }})</h4>
                                        <div class="image-container">
                                            <img src="{{ call.ref_image_url }}" alt="Reference Image" class="api-call-image">
                                            {% if call.original_keypoints %}
                                            <div class="keypoints-overlay">
                                                {% for kp in call.original_keypoints %}
                                                <div class="keypoint-marker original" style="left: {{ kp[0] if kp is sequence else kp.x }}px; top: {{ kp[1] if kp is sequence else kp.y }}px;"></div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if call.target_image_url %}
                                    <div class="image-display">
                                        <h4>üîç Target Image ({{ call.target_image_size or 'Unknown' }})</h4>
                                        <div class="image-container">
                                            <img src="{{ call.target_image_url }}" alt="Target Image" class="api-call-image">
                                            {% if call.tracked_keypoints %}
                                            <div class="keypoints-overlay">
                                                {% for kp in call.tracked_keypoints %}
                                                <div class="keypoint-marker tracked" style="left: {{ kp[0] if kp is sequence else kp.x }}px; top: {{ kp[1] if kp is sequence else kp.y }}px;"></div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="metadata-section">
                                    <h4>üìä Computation Metadata</h4>
                                    <div class="metadata-grid">
                                        <div class="metadata-item highlight">
                                            <span class="metadata-label">Input Keypoints:</span>
                                            <span class="metadata-value">{{ call.keypoints_count or 0 }}</span>
                                        </div>
                                        <div class="metadata-item highlight">
                                            <span class="metadata-label">Tracked Points:</span>
                                            <span class="metadata-value tracked">{{ call.tracked_points or 0 }}</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="metadata-label">Processing Time:</span>
                                            <span class="metadata-value">{{ call.processing_time }}s</span>
                                        </div>
                                        {% if call.detailed_metadata %}
                                            {% for key, value in call.detailed_metadata.items() %}
                                            <div class="metadata-item">
                                                <span class="metadata-label">{{ key.replace('_', ' ').title() }}:</span>
                                                <span class="metadata-value">{{ value }}</span>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    
                                    {% if not call.success and call.error %}
                                    <div class="error-details">
                                        <h5>‚ùå Error Details:</h5>
                                        <p class="error-message">{{ call.error }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="call-footer">
                                <span class="call-message">{{ call.message }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="no-api-calls">
                        <div class="empty-state">
                            <span class="empty-icon">üìã</span>
                            <h3>No API Calls Yet</h3>
                            <p>API calls to this service will appear here in real-time</p>
                            <p><strong>Available Endpoints:</strong></p>
                            <div class="endpoint-examples">
                                <code>POST /set_reference_image</code>
                                <code>POST /track_keypoints</code>
                                <code>GET /references</code>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="api-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total API Calls:</span>
                        <span class="stat-value">{{ total_api_calls }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Service Uptime:</span>
                        <span class="stat-value" id="uptime-counter">Active</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Last Updated:</span>
                        <span class="stat-value" id="last-updated">{{ recent_api_calls[0].timestamp if recent_api_calls else 'Never' }}</span>
                    </div>
                </div>

                <!-- Refresh Controls -->
                <div class="refresh-controls" style="margin-top: 15px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <button class="btn btn-secondary" id="refresh-api-logs" title="Manually refresh API logs">
                        üîÑ Refresh Now
                    </button>
                    <div class="auto-refresh-toggle" style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="auto-refresh-toggle" checked>
                        <label for="auto-refresh-toggle" style="font-size: 0.9em; color: #7f8c8d;">Auto-refresh (5s)</label>
                    </div>
                </div>

                <!-- Demo Controls -->
                <div class="demo-controls" style="margin-top: 20px; text-align: center;">
                    <h4>üß™ Demo API Calls</h4>
                    <p style="color: #7f8c8d; font-size: 0.9em; margin: 10px 0;">Generate sample API calls to see the monitoring in action</p>
                    <button class="btn btn-info" onclick="makeDemoAPICall()" id="demo-btn">
                        üöÄ Generate Demo API Call
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section" id="results-section" style="display: none;">
            <div class="results-card">
                <h2>üìà Tracking Results</h2>
                <div class="results-content" id="results-content">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Visualization Section (for future enhancement) -->
        <div class="visualization-section" id="visualization-section" style="display: none;">
            <div class="visualization-card">
                <h2>üé® Visualization</h2>
                <div class="visualization-content" id="visualization-content">
                    <canvas id="visualization-canvas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>üéõÔ∏è Service Control</h2>
            <div class="control-actions">
                <button onclick="refreshStatus()" class="btn btn-success">
                    <span id="refresh-text">üîÑ Refresh Status</span>
                </button>
                <a href="/health" class="btn btn-info">‚ù§Ô∏è Health Check</a>
                <a href="/references" class="btn btn-info">üìö References API</a>
                <a href="/docs" class="btn btn-primary">üìñ API Docs</a>
                <a href="http://localhost:8000" class="btn btn-secondary">üè† Control Center</a>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 FlowFormer++ Keypoint Tracking Service | Part of Robot Vision Suite</p>
        </footer>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loading-message">Processing...</p>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>